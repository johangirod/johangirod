<!doctype html>
<html lang="fr">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../../../favicon.png" />

		<meta name="viewport" content="width=device-width" />
		
		<link href="../../../_app/immutable/assets/0.DeOizrWX.css" rel="stylesheet">
		<link href="../../../_app/immutable/assets/2.Dz1qT87F.css" rel="stylesheet">
		<link rel="modulepreload" href="../../../_app/immutable/entry/start.Bnp5303b.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/Cugo8Sw9.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/_Roc1N7j.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/Du4uIILg.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/DYGiXs1v.js">
		<link rel="modulepreload" href="../../../_app/immutable/entry/app.gFT0rYy9.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/jKjWACjA.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/CozvbqRy.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/CU3E0FLs.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/B4pklceG.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/pFiT_qqh.js">
		<link rel="modulepreload" href="../../../_app/immutable/nodes/0.BjDQT2Bq.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/CMei0t4b.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/Bgovi1YL.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/D4AmcDfz.js">
		<link rel="modulepreload" href="../../../_app/immutable/nodes/2.CBLjlu0K.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/B0BGekoV.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/BMkXc6el.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/Cv3pZryr.js">
		<link rel="modulepreload" href="../../../_app/immutable/nodes/19.BZMe36rb.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/Cs1o_ong.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/DyuDGlf2.js">
		<link rel="modulepreload" href="../../../_app/immutable/chunks/OjqImkSQ.js"><!--[--><!--]--><!--[--><!--]--><title>Serveur web avec SQL - Johan Girod</title>
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><div class="screen:container prose-h2 container prose prose-slate mx-auto my-12 px-4 lg:prose-xl prose-headings:text-slate-800 prose-h1:font-semibold prose-a:transition prose-a:duration-75 hover:prose-a:text-pink-500 lg:px-0 print:mx-0 print:max-w-none"><!----><!--[--><!----><div class="lg:prose-lg"><div style="view-transition-name: breadcrumb"><div class="mb-2 inline" role="list"><!--[--><li class="inline-block"><a href="/" class="text-pink-600" aria-label="Accueil">Accueil</a> <!--[--><span class="mx-2 text-gray-500">/</span><!--]--></li><li class="inline-block"><a href="/cours/" class="text-pink-600" aria-label="Cours et TP">Cours et TP</a> <!--[--><span class="mx-2 text-gray-500">/</span><!--]--></li><li class="inline-block"><a href="http://sveltekit-prerender/cours/tw3/4-web-and-SQL/" class="text-pink-600" aria-label="...">...</a> <!--[!--><!--]--></li><!--]--></div><!----> <!--[--><span class="ml-2 inline-block rounded-full bg-pink-500 px-2 py-1 text-sm font-semibold text-white">Avec corrigé</span><!--]--></div> <main class="mt-8 prose-h1:inline-block prose-h1:border-y-8 prose-h1:border-pink-500 prose-h1:px-2 prose-h1:pb-3 prose-h1:pt-2 prose-h1:text-4xl prose-h2:text-3xl"><!----><!--[!--><!----><h1>Serveur web et base de données</h1> <p>Ce TP vous permettra de créer un serveur web avec express, et de le connecter à une base de données SQL.</p> <p>Nous reprendrons le projet du TP précédent, et nous ajouterons une base de données pour stocker les données des menus et des commandes.</p> <p>Nous créerons une nouvelle vue pour le restaurateur qui affiche les commandes effectuées.</p> <h2>Objectifs d’apprentissage</h2> <ul><li>Continuer d’approfondir l’architecture MVC (Modèle-Vue-Contrôleur)</li> <li>Utiliser un router avec express</li> <li>Refactorer du code en s’appuyant sur des tests</li> <li>Utiliser une base de données dans une application web (lecture et écriture)</li> <li>Utiliser async/await pour gérer les promesses dans un cas d’utilisation réel</li></ul> <h2>Sommaire</h2> <ul><li><a href="#start">Préparatifs</a></li> <li><a href="#exercice-1">Exercice 1 : refactoring du code</a></li> <li><a href="#exercice-2">Exercice 2 : utiliser la base de données en lecture</a></li> <li><a href="#exercice-3">Exercice 3 : utiliser la base de données en écriture</a></li> <li><a href="#exercice-4">Exercice 4 : créer une page qui liste toutes les commandes</a></li></ul> <span id="start"></span> <h2>Préparatifs : installer et lancer le projet</h2> <p>Cette fois-ci, nous utiliserons l’environnement de développement sur les machines de l’école.</p> <p>Des scripts docker ont été créés pour lancer le serveur et la base de données.</p> <h3>Clonage du projet</h3> <p>Le code se trouve sur Github. Pour installer le projet, lancer les commandes suivantes :</p> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#6A737D"># Clone le projet git dans le dossier courant</span></span>
<span class="line"><span style="color:#6F42C1">git</span><span style="color:#032F62"> clone</span><span style="color:#005CC5"> --branch</span><span style="color:#032F62"> TP-2</span><span style="color:#032F62"> https://github.com/johangirod/TP-serveur-web</span></span>
<span class="line"><span style="color:#005CC5">cd</span><span style="color:#032F62"> TP-serveur-web</span></span></code></pre><!----> <h3>Présentation du projet</h3> <p>Ce projet reprend à la fin de l’exercice 2 du TP précédent. Il contient donc déjà un serveur web avec express, les vues, et les routes permettant d’afficher les menus et de commander.</p> <p>Le code se trouve dans le dossier <code>src</code>.</p> <p>Ouvrez le dossier dans vscode avec la commande <code>code .</code>. Vous pouvez parcourir le code source pour vous familiariser avec le projet.</p> <p>Il y a une petite différence dans le fichier <code>index.ts</code> avec le TP précédent. Pouvez-vous la trouver ?</p> <!--[--><div class="-ml-5 border-l-2 border-dotted border-pink-500 pl-4"><span class="mr-2 inline-block rounded-full bg-pink-500 px-2 py-1 text-sm font-semibold text-white">Corrigé</span> <button class="inline-block text-sm text-gray-500 hover:text-gray-700" aria-label="Afficher la solution" aria-expanded="false" aria-controls="00hy3kis2xvjr"><!--[!-->Afficher<!--]--></button> <!--[!--><!--]--></div><!--]--><!----> <h4>Installer les extensions vscode</h4> <p>Pour profiter des annotations eslint et du formattage automatique de prettier dans vscode, il vous suffit d’installer les extensions recommandées du projet. Pour cela, ouvrez le menu des extensions (<code>Ctrl+Maj+X</code>) et cherchez “@recommended”. Vous devriez voir apparaître les extensions suivantes :</p> <ul><li>ESLint</li> <li>Prettier - Code formatter</li></ul> <h3>Lancer le projet</h3> <p>Ce projet utilise une base de données mySQL. Pour créer et lancer un container docker avec la base de données, lancer la commande suivante :</p> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#6F42C1">sh</span><span style="color:#032F62"> scripts/database-start.sh</span></span></code></pre><!----> <p>Pour initialiser la base de données et lancer le serveur, lancer la commande suivante :</p> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#6F42C1">sh</span><span style="color:#032F62"> scripts/start.sh</span></span></code></pre><!----> <p>Vérifiez que le serveur est bien lancé en allant sur <code>http://localhost:3000</code>.</p> <p>Lancez les tests et vérifiez que tout est vert avec la commande suivante :</p> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#6F42C1">sh</span><span style="color:#032F62"> scripts/test.sh</span></span></code></pre><!----> <p>A tout moment, vous pouvez voir les logs du serveur avec la commande suivante :</p> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#6F42C1">docker</span><span style="color:#032F62"> logs</span><span style="color:#005CC5"> -f</span><span style="color:#032F62"> app</span></span></code></pre><!----> <span id="exercice-1"></span> <h2>Exercice 1 : refactoring du code</h2> <p>Le fichier <code>index.ts</code> contient tout le code du serveur. Nous allons le découper en plusieurs fichiers pour améliorer la lisibilité et la maintenabilité du code. C’est ce qu’on appelle le refactoring ( « refactorisation » ou « remaniement » en français)</p> <p>Nous nous baserons sur l’architecture MVC (Modèle-Vue-Contrôleur) pour découper le code.</p> <img src="/images/mvc_express.png" alt="Architecture MVC" style="width: 100%"> <p>À chaque étape de l’exercice, vous pourrez lancer les tests pour vérifier que tout fonctionne toujours.</p> <div class="bg-blue-100 border-l-4 border-blue-500 px-4 py-2"><p class="font-bold text-blue-700"><!----><div slot="title">A quoi sert le refactoring ?</div><!----></p> <!----><p>Le refactoring est une étape importante dans le développement d’une application. Il permet de rendre le code plus lisible et plus maintenable.</p> <p>En effet, plus l’application grandit, plus il devient difficile de comprendre le code et de le modifier si tout est dans un seul fichier.</p><!----></div><!----> <h3>Utiliser un router</h3> <p>Créer un fichier <code>src/routes.ts</code>. Nous allons déplacer les routes de l’application dans ce fichier. Il ne restera plus que la configuration du serveur dans <code>index.ts</code>.</p> <p>Pour créer un router avec express, nous utiliserons la méthode <code>Router</code> d’express.</p> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> express </span><span style="color:#D73A49">from</span><span style="color:#032F62"> 'express'</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> router</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> express.</span><span style="color:#6F42C1">Router</span><span style="color:#24292E">();</span></span></code></pre><!----> <p>On peut ensuite ajouter des routes à ce router avec les méthodes <code>get</code>, <code>post</code>, etc, de la même façon qu’avec l’objet <code>app</code>.</p> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#24292E">router.</span><span style="color:#6F42C1">get</span><span style="color:#24292E">(</span><span style="color:#032F62">'/'</span><span style="color:#24292E">, (</span><span style="color:#E36209">req</span><span style="color:#24292E">, </span><span style="color:#E36209">res</span><span style="color:#24292E">) </span><span style="color:#D73A49">=></span><span style="color:#24292E"> &#123;</span></span>
<span class="line"><span style="color:#6A737D">	// ...</span></span>
<span class="line"><span style="color:#24292E">&#125;);</span></span></code></pre><!----> <p>Déplacer toutes les routes du fichier <code>index.ts</code> vers le fichier <code>routes.ts</code>, en remplaçant <code>app</code> par <code>router</code>. N’oubliez pas d’exporter le router à la fin du fichier avec <code>export default router</code> (sinon il ne pourra pas être importé dans les autres fichiers).</p> <div class="bg-blue-100 border-l-4 border-blue-500 px-4 py-2"><p class="font-bold text-blue-700"><!----><div slot="title">Qu'est-ce qu'une route ?</div><!----></p> <!----><p>Une route est définie par une méthode HTTP et un chemin. Par exemple, la route <code>GET /</code> correspond à la page d’accueil, et la route <code>POST /commander</code> correspond à la page de commande.</p> <p>Avec Express, on peut définir une route avec les méthodes <code>get</code> ou <code>post</code> par exemple (comme vu dans le TP précédent).</p><!----></div><!----> <p>Pour utiliser ce router dans l’application, il faut l’ajouter à l’application avec la méthode <code>use</code> :</p> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> router </span><span style="color:#D73A49">from</span><span style="color:#032F62"> './routes'</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#6A737D">// &#x3C;...></span></span>
<span class="line"><span style="color:#24292E">app.</span><span style="color:#6F42C1">use</span><span style="color:#24292E">(router);</span></span></code></pre><!----> <!--[--><div class="-ml-5 border-l-2 border-dotted border-pink-500 pl-4"><span class="mr-2 inline-block rounded-full bg-pink-500 px-2 py-1 text-sm font-semibold text-white">Corrigé</span> <button class="inline-block text-sm text-gray-500 hover:text-gray-700" aria-label="Afficher la solution" aria-expanded="false" aria-controls="p8cs35451ra"><!--[!-->Afficher<!--]--></button> <!--[!--><!--]--></div><!--]--><!----> <h3>Définir les contrôleurs</h3> <div class="bg-blue-100 border-l-4 border-blue-500 px-4 py-2"><p class="font-bold text-blue-700"><!----><div slot="title">Qu'est-ce qu'un contrôleur ?</div><!----></p> <!----><p>Un contrôleur est la fonction qui est appelée lorsqu’une route est activée. Il prend en paramètre la requête et la réponse, et effectue des actions dans la réponse en fonction de la requête. Il peut, par exemple, récupérer des données dans le modèle, et les afficher dans une vue.</p><!----></div><!----> <p>Créer un fichier <code>src/controllers.ts</code>. Nous allons déplacer les fonctions de callback des routes dans ce fichier.</p> <p>Ce fichier devra exporter les fonctions suivantes :</p> <ul><li><code>getHomePage</code></li> <li><code>getMenusPage</code></li> <li><code>getCommanderPage</code></li> <li><code>createCommandeFromFormulaire</code></li></ul> <p>Déplacer les fonctions de callback des routes dans ce fichier, et remplacer les fonctions de callback par les fonctions du controller.</p> <p>Pour garder la signature des fonctions, il faudra ajouter les types <code>Request</code> et <code>Response</code> d’express aux paramètres.</p> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#6A737D">// src/controllers.ts</span></span>
<span class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> &#123; Request, Response &#125; </span><span style="color:#D73A49">from</span><span style="color:#032F62"> 'express'</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">export</span><span style="color:#D73A49"> function</span><span style="color:#6F42C1"> getHomePage</span><span style="color:#24292E">(</span><span style="color:#E36209">req</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Request</span><span style="color:#24292E">, </span><span style="color:#E36209">res</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Response</span><span style="color:#24292E">) &#123;</span></span>
<span class="line"><span style="color:#6A737D">	// &#x3C;...></span></span>
<span class="line"><span style="color:#24292E">&#125;</span></span></code></pre><!----> <!--[--><div class="-ml-5 border-l-2 border-dotted border-pink-500 pl-4"><span class="mr-2 inline-block rounded-full bg-pink-500 px-2 py-1 text-sm font-semibold text-white">Corrigé</span> <button class="inline-block text-sm text-gray-500 hover:text-gray-700" aria-label="Afficher la solution" aria-expanded="false" aria-controls="8yzffasxzps"><!--[!-->Afficher<!--]--></button> <!--[!--><!--]--></div><!--]--><!----> <p>Les tests passent toujours ? Parfait ! Nous pouvons continuer.</p> <span id="exercice-2"></span> <h2>Exercice 2 : utiliser la base de données en lecture</h2> <p>Nous allons maintenant faire en sorte que notre application utilise une base de données pour récupérer les informations sur les menus et les commandes.</p> <p>La base de données est déjà créée et contient les données des menus, ainsi qu’une table vide pour les commandes.</p> <p>Vous pouvez explorer la base grâce à la commande suivante :</p> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#6F42C1">sh</span><span style="color:#032F62"> scripts/database-cli.sh</span></span></code></pre><!----> <p>Le mot de passe est <code>secret</code>.</p> <p>Pour voir la table des menus, lancer la commande suivante :</p> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#D73A49">SELECT</span><span style="color:#D73A49"> *</span><span style="color:#D73A49"> FROM</span><span style="color:#24292E"> menus;</span></span></code></pre><!----> <p>Vous devriez voir apparaître la liste des menus, avec le nom, la description, le prix, et l’id.</p> <h3>Récupérer les menus dans la base de données</h3> <p>Dans le fichier <code>src/models.ts</code>, nous allons modifier la fonction <code>getAllMenus</code> pour qu’elle utilise la base de données plutôt que l’objet <code>menus</code>.</p> <p>Pour cela, nous allons créer une connection à la base de données avec le module <code>mysql2</code>.</p> <ol><li><p>Importer le module <code>mysql2/promise</code> dans le fichier <code>models.ts</code>.</p> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#6A737D">// models.ts</span></span>
<span class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> mysql </span><span style="color:#D73A49">from</span><span style="color:#032F62"> 'mysql2/promise'</span><span style="color:#24292E">;</span></span></code></pre><!----></li> <li><p>Dans ce même fichier, créer une connexion à la base de données avec les informations de connexion stockées dans les variables d’environnement.</p> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#6A737D">// models.ts</span></span>
<span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> db</span><span style="color:#D73A49"> =</span><span style="color:#D73A49"> await</span><span style="color:#24292E"> mysql.</span><span style="color:#6F42C1">createConnection</span><span style="color:#24292E">(&#123;</span></span>
<span class="line"><span style="color:#24292E">	host: process.env.</span><span style="color:#005CC5">MYSQL_HOST</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">	user: process.env.</span><span style="color:#005CC5">MYSQL_USER</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">	database: process.env.</span><span style="color:#005CC5">MYSQL_DB</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">	password: process.env.</span><span style="color:#005CC5">MYSQL_PASSWORD</span></span>
<span class="line"><span style="color:#24292E">&#125;);</span></span></code></pre><!----> <div class="bg-blue-100 border-l-4 border-blue-500 px-4 py-2"><p class="font-bold text-blue-700"><!----><div slot="title">Pourquoi utiliser des variables d'environnement ?</div><!----></p> <!----><p>Les variables d’environnement permettent de <strong>stocker des informations sensibles</strong>, comme les identifiants de connexion à la base de données, <strong>en dehors du code source</strong>.</p> <p>Cela permet de garder ces informations confidentielles, et de les changer facilement en fonction de l’environnement (développement, production, etc).</p><!----></div><!----></li> <li><p>Rendre la fonction <code>getAllMenus</code> asynchrone, en ajoutant le mot clé <code>async</code> devant la fonction et changeant le type de retour de <code>Array&lt;Menu></code> à <code>Promise&lt;Array&lt;Menu>></code>.</p></li> <li><p>Récupérer les menus dans la base de données avec une commande SQL grâce à la méthode <code>db.execute</code></p> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#6A737D">// function getAllMenus()</span></span>
<span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> queryResult</span><span style="color:#D73A49"> =</span><span style="color:#D73A49"> await</span><span style="color:#24292E"> db.</span><span style="color:#6F42C1">execute</span><span style="color:#24292E">(</span><span style="color:#032F62">'SELECT * FROM menus'</span><span style="color:#24292E">);</span></span>
<span class="line"><span style="color:#D73A49">return</span><span style="color:#24292E"> queryResult[</span><span style="color:#005CC5">0</span><span style="color:#24292E">] </span><span style="color:#D73A49">as</span><span style="color:#6F42C1"> Array</span><span style="color:#24292E">&#x3C;</span><span style="color:#6F42C1">Menu</span><span style="color:#24292E">>;</span></span></code></pre><!----> <ul><li><em>Note : <code>execute</code> retourne un tableau de deux éléments : le résultat de la requête (les menus), et les métadonnées de la requête (le type des colonnes retournées par exemple).</em></li> <li><em>Note 2 : Typescript ne peut pas deviner le type de retour de <code>execute</code>, il faut donc le préciser avec <code>as Array&lt;Menu></code>.</em></li></ul></li> <li><p>Modifier le controller <code>getMenusPage</code> pour qu’il attende que la fonction <code>getAllMenus</code> soit terminée avant de continuer en ajoutant le mot clé <code>async</code> devant <code>function</code> et le mot clé <code>await</code> devant <code>getAllMenus</code>.</p></li></ol> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#6A737D">// controller getMenusPage</span></span>
<span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> menus</span><span style="color:#D73A49"> =</span><span style="color:#D73A49"> await</span><span style="color:#6F42C1"> getAllMenus</span><span style="color:#24292E">();</span></span></code></pre><!----> <p><em>Note : il n’y a pas de tests pour cet exercice. Vous pouvez vérifier que tout fonctionne en lançant le serveur et en allant sur la page des menus.</em></p> <!--[--><div class="-ml-5 border-l-2 border-dotted border-pink-500 pl-4"><span class="mr-2 inline-block rounded-full bg-pink-500 px-2 py-1 text-sm font-semibold text-white">Corrigé</span> <button class="inline-block text-sm text-gray-500 hover:text-gray-700" aria-label="Afficher la solution" aria-expanded="false" aria-controls="i1z1ale13o"><!--[!-->Afficher<!--]--></button> <!--[!--><!--]--></div><!--]--><!----> <h3>Récupérer un menu par son id</h3> <p>De la même manière, nous allons modifier la fonction <code>getMenuById</code> pour qu’elle utilise la base de données. La requête SQL pour récupérer un menu par son id est la suivante :</p> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#D73A49">SELECT</span><span style="color:#D73A49"> *</span><span style="color:#D73A49"> FROM</span><span style="color:#24292E"> menus </span><span style="color:#D73A49">WHERE</span><span style="color:#24292E"> id </span><span style="color:#D73A49">=</span><span style="color:#24292E"> ?</span></span></code></pre><!----> <p>La fonction <code>execute</code> remplacera les <code>?</code> par les valeurs passées dans un tableau en second paramètre :</p> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#6A737D">// la valeur de &#96;id&#96; remplacera le &#96;?&#96; dans la requête</span></span>
<span class="line"><span style="color:#24292E">db.</span><span style="color:#6F42C1">execute</span><span style="color:#24292E">(</span><span style="color:#032F62">'SELECT * FROM menus WHERE id = ?'</span><span style="color:#24292E">, [id]);</span></span></code></pre><!----> <p>Vérifiez que tout fonctionne en cliquant sur « commander » sur la page des menus (n’oubliez pas de modifier le controller également).</p> <!--[--><div class="-ml-5 border-l-2 border-dotted border-pink-500 pl-4"><span class="mr-2 inline-block rounded-full bg-pink-500 px-2 py-1 text-sm font-semibold text-white">Corrigé</span> <button class="inline-block text-sm text-gray-500 hover:text-gray-700" aria-label="Afficher la solution" aria-expanded="false" aria-controls="lkf1cbj46i"><!--[!-->Afficher<!--]--></button> <!--[!--><!--]--></div><!--]--><!----> <span id="exercice-3"></span> <h2>Exercice 3 : utiliser la base de données en écriture</h2> <p>Le but de cet exercice est de sauvegarder les commandes passées par les clients dans la base de données.</p> <h3>Créer un modèle pour une commande</h3> <ol><li><p>Ajouter une section <code>commandes</code> dans le fichier <code>models.ts</code> (comme pour les sections <code>menus</code> et <code>restaurant</code>).</p></li> <li><p>Créer un type typescript <code>Commande</code> avec les propriétés suivantes :</p> <ul><li><code>id</code> : un identifiant unique pour la commande</li> <li><code>name</code> : le nom du client</li> <li><code>address</code> : l’adresse du client</li> <li><code>phone</code> : le numéro de téléphone du client</li> <li><code>menuId</code> : l’id du menu commandé</li></ul></li> <li><p>Créer une fonction <code>createCommande</code> avec le type suivant :</p></li></ol> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#D73A49">export</span><span style="color:#D73A49"> async</span><span style="color:#D73A49"> function</span><span style="color:#6F42C1"> createCommande</span><span style="color:#24292E">(</span></span>
<span class="line"><span style="color:#E36209">	name</span><span style="color:#D73A49">:</span><span style="color:#005CC5"> string</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#E36209">	address</span><span style="color:#D73A49">:</span><span style="color:#005CC5"> string</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#E36209">	phone</span><span style="color:#D73A49">:</span><span style="color:#005CC5"> string</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#E36209">	menuId</span><span style="color:#D73A49">:</span><span style="color:#005CC5"> string</span></span>
<span class="line"><span style="color:#24292E">)</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Promise</span><span style="color:#24292E">&#x3C;</span><span style="color:#6F42C1">Commande</span><span style="color:#24292E">> &#123;</span></span>
<span class="line"><span style="color:#6A737D">	// &#x3C;...></span></span>
<span class="line"><span style="color:#24292E">&#125;</span></span></code></pre><!----> <ol start="4"><li>Utiliser la méthode <code>execute</code> avec une la requête SQL suivante pour insérer une nouvelle commande dans la base de données :</li></ol> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#D73A49">INSERT INTO</span><span style="color:#24292E"> orders (</span><span style="color:#D73A49">name</span><span style="color:#24292E">, </span><span style="color:#D73A49">address</span><span style="color:#24292E">, phone, menu_id) </span><span style="color:#D73A49">VALUES</span><span style="color:#24292E"> (?, ?, ?, ?)</span></span></code></pre><!----> <ol start="5"><li>Retourner la commande créée avec l’id généré par la base de données. Pour cela on peut utiliser la propriété <code>insertId</code> retournée par <code>execute</code>.</li></ol> <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#D73A49">const</span><span style="color:#005CC5"> commandeId</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> queryResult[</span><span style="color:#005CC5">0</span><span style="color:#24292E">].insertId;</span></span></code></pre><!----> <ol start="6"><li>Modifier le controller <code>createCommandeFromFormulaire</code> pour qu’il utilise la fonction <code>createCommande</code> et qu’il affiche l’id de la commande dans le message de confirmation.</li></ol> <p><em>Pour tester, vous pouvez créer une commande avec le formulaire, et vérifier que la commande est bien créée dans la base de données avec la commande <code>SELECT * FROM orders</code>, via le script <code>scripts/database-cli.sh</code>.</em></p> <!--[--><div class="-ml-5 border-l-2 border-dotted border-pink-500 pl-4"><span class="mr-2 inline-block rounded-full bg-pink-500 px-2 py-1 text-sm font-semibold text-white">Corrigé</span> <button class="inline-block text-sm text-gray-500 hover:text-gray-700" aria-label="Afficher la solution" aria-expanded="false" aria-controls="nct6l3m8dl"><!--[!-->Afficher<!--]--></button> <!--[!--><!--]--></div><!--]--><!----> <span id="exercice-4"></span> <h2>Exercice 4 : créer une page qui liste toutes les commandes</h2> <h3>Créer une nouvelle page commandes</h3> <p>Créer une nouvelle page <code>/commandes</code> qui affiche la liste des commandes passées, avec le nom, l’adresse, le téléphone et l’id du menu commandé.</p> <p>Vous devrez créer une route, un controller, une vue, et une nouvelle fonction dans le modèle.</p> <!--[--><div class="-ml-5 border-l-2 border-dotted border-pink-500 pl-4"><span class="mr-2 inline-block rounded-full bg-pink-500 px-2 py-1 text-sm font-semibold text-white">Corrigé</span> <button class="inline-block text-sm text-gray-500 hover:text-gray-700" aria-label="Afficher la solution" aria-expanded="false" aria-controls="h1rwmlfq5io"><!--[!-->Afficher<!--]--></button> <!--[!--><!--]--></div><!--]--><!----> <h3>Afficher le nom du menu commandé avec la commande</h3> <p>Dans la liste des commandes, on veut afficher le nom du menu commandé plutôt que son id. Pour cela, il faut modifier la fonction du modèle pour qu’elle récupère le nom du menu avec une jointure SQL.</p> <ol><li>Modifier le type <code>Commande</code> pour ajouter la propriété <code>menuName</code> de type <code>string</code>. Cette propriété sera facultative (<code>menuName?: string;</code>), car elle ne sera pas retournée par la fonction <code>createCommande</code>.</li> <li>Modifier la fonction du modèle pour qu’elle récupère le nom du menu avec une jointure SQL. <!----><pre class="shiki github-light" style="background-color:#fff;color:#24292e" tabindex="0"><code><span class="line"><span style="color:#D73A49">SELECT</span><span style="color:#24292E"> orders.</span><span style="color:#D73A49">*</span><span style="color:#24292E">, </span><span style="color:#005CC5">orders</span><span style="color:#24292E">.</span><span style="color:#005CC5">menu_id</span><span style="color:#D73A49"> as</span><span style="color:#24292E"> menuId, </span><span style="color:#005CC5">menus</span><span style="color:#24292E">.</span><span style="color:#005CC5">name</span><span style="color:#D73A49"> AS</span><span style="color:#24292E"> menuName </span><span style="color:#D73A49">FROM</span><span style="color:#24292E"> orders </span><span style="color:#D73A49">JOIN</span><span style="color:#24292E"> menus </span><span style="color:#D73A49">ON</span><span style="color:#005CC5"> orders</span><span style="color:#24292E">.</span><span style="color:#005CC5">menu_id</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> menus</span><span style="color:#24292E">.</span><span style="color:#005CC5">id</span></span></code></pre><!----></li> <li>Modifier la vue et le controller</li></ol> <h2>Bonus : améliorations</h2> <h3>Ajouter des filtres sur la page des commandes</h3> <p>Sur la page des commandes, ajouter des boutons pour filtrer les commandes par menu commandé. Vous devrez :</p> <ul><li>créer une nouvelle fonction dans le modèle <code>getCommandesByMenuId</code> qui prend en paramètre l’id du menu et retourne la liste des commandes correspondantes.</li> <li>ajouter un lien par menu dans le fichier <code>commandes.handlebars</code> qui pointe vers la page <code>/commandes?menu=ID_DU_MENU</code></li> <li>modifier le controller créer précédement pour qu’il utilise la nouvelle fonction du modèle si l’id du menu est présent dans la requête.</li></ul> <h3>Ajouter un bouton pour supprimer une commande</h3> <p>Ajouter un bouton pour supprimer une commande à côté de la commande. Pour cela, il faudra créer une nouvelle route et un nouveau controller. Cette route aura pour méthode <code>post</code> et prendra en paramètre l’id de la commande à supprimer : <code>/commandes/delete/:id</code>.</p> <h3>Ajouter la gestion d’erreur</h3> <p>Que se passe-t-il si la base de données n’est pas disponible ? Modifiez les controllers pour prendre en compte le cas où l’appel au modèle retourne une erreur.</p><!----><!--]--><!----></main></div><!----><!--]--><!----></div><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_pqo0dy = {
						base: new URL("../../..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../../../_app/immutable/entry/start.Bnp5303b.js"),
						import("../../../_app/immutable/entry/app.gFT0rYy9.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 2, 19],
							data: [{"type":"data","data":null,"uses":{}},null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
